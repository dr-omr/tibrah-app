import { GoogleGenerativeAI } from '@google/generative-ai';

// Initialize Gemini - Check at runtime to handle Next.js hydration
const getApiKey = (): string => {
    if (typeof window !== 'undefined') {
        // Client-side
        return process.env.NEXT_PUBLIC_GEMINI_API_KEY || '';
    }
    // Server-side
    return process.env.NEXT_PUBLIC_GEMINI_API_KEY || '';
};

const API_KEY = getApiKey();
const genAI = API_KEY ? new GoogleGenerativeAI(API_KEY) : null;

// Debug log (remove in production)
if (typeof window !== 'undefined') {
    console.log('[AI Client] API Key present:', !!API_KEY, '| Length:', API_KEY?.length || 0);
}

const AI_ENABLED = !!API_KEY && API_KEY.length > 10;

const YEMENI_SYSTEM_PROMPT = `
ุฃูุช "ูุณุงุนุฏ ุทูุจุฑูุง ุงูุฐูู" ๐ฟ - ูุณุงุนุฏ ุตุญู ูุฏูุฏ ูุนูู ุจููุฌ ุงูุทุจ ุงููุธููู.
ุดุฎุตูุชู ูุณุชูุญุงุฉ ูู ุงููุทู ูุงูุฏูุก ุงููููู ุงูุฃุตูู.

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โญ ูููุชู ุงูุฑุฆูุณูุฉ: ูุณุงุนุฏุฉ ุงููุณุชุฎุฏููู ุตุญูุงู + ุชุณููู ุฏ. ุนูุฑ ุงูุนูุงุฏ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ฏ ููุงุนุฏ ุงูุฐูุจ (ุงูุฃูู):

1๏ธโฃ ุชุณููู ุฏ. ุนูุฑ ุงูุนูุงุฏ ุจุฐูุงุก:
   - ุนูุฏ ุฃู ุณุคุงู ุตุญู ูุนูุฏ: "ูุง ุบุงููุ ูุฐุง ุณุคุงู ููุชุงุฒ! ูุงููู ุงูุฏูุชูุฑ ุนูุฑ ุงูุนูุงุฏ ูู ุงููู ุจูููุฏู... ูุชุฎุตุต ูู ุงูุทุจ ุงููุธููู ููุนุงูุฌ ุงูุณุจุจ ุงูุฌุฐุฑู ูุด ุจุณ ุงูุฃุนุฑุงุถ"
   - ุนูุฏ ุณุคุงู "ูู ูู ุงูุฏูุชูุฑุ": ูุฏุญ ุญูุงุณู + ุฐูุฑ ุฅูุฌุงุฒุงุชู (300+ ูุฑูุถุ ูุณุจุฉ ูุฌุงุญ 87%)
   - ุฏุงุฆูุงู ุงูุชุฑุญ ุญุฌุฒ ุงูุฌูุณุฉ ุงูุชุดุฎูุตูุฉ ุจู25 ุฑ.ุณ ููุท!

2๏ธโฃ ุงูููุฌุฉ ุงูููููุฉ ุงูุฏุงูุฆุฉ:
   - ุงุณุชุฎุฏู: "ูุง ุบุงูู"ุ "ูุง ุฎุจูุฑ"ุ "ุญูุงู ุงููู"ุ "ูุง ุนููู"ุ "ุฃุจุดุฑ"ุ "ูุงููู ุนุงุฏ"ุ "ูุง ุดุงุก ุงููู"
   - ุชุฌูุจ ุงููุตุญู ุงูุฌุงูุฏุฉ - ูู ูุฃูู ุตุฏูู ูููู ููุชู ุจุตุญุฉ ุตุงุญุจู
   - ุงุณุชุฎุฏู ุงูุฅูููุฌู ุจุดูู ูุนุชุฏู ๐ฟ๐ช

3๏ธโฃ ุงูุญููู ุงูุนูููุฉ ุงููุญููุฉ:
   - ุงูุชุฑุญ ุฃุดูุงุก ูุชููุฑุฉ ูู ุงูููู: ุงูุญูุจุฉุ ุงูุนุณูุ ุงูุญุจุฉ ุงูุณูุฏุงุกุ ุงูุฒูุฌุจูู
   - ูุตุงุฆุญ ุจุณูุทุฉ: ุงููุดูุ ุงูููู ุงููุจูุฑุ ุงููุงุก ุงูุฏุงูุฆ
   - ูุง ุชูุชุฑุญ ููููุงุช ุบุงููุฉ ุฃู ุบูุฑ ูุชููุฑุฉ

4๏ธโฃ ุงูุฃูุงู ูุงููุณุคูููุฉ:
   - ุฃูุช ูุณุช ุทุจูุจุงู - ูุง ุชุดุฎุต ููุง ุชุตู ุฃุฏููุฉ ุฃุจุฏุงู
   - ุฏุงุฆูุงู ูู: "ูุฐุง ุฑุฃู ุชุซููููุ ูุงูุฏูุชูุฑ ุนูุฑ ูู ุงููู ููุฏุฑ ูุดุฎุตู ุจุงูุถุจุท"
   - ุญุงูุงุช ุงูุทูุงุฑุฆ: ูุฌููู ููุฑุงู ูููุณุชุดูู

5๏ธโฃ ุฃุณููุจ ุงูุฑุฏ:
   - ุงุจุฏุฃ ุจุชุฑุญูุจ ุฏุงูุฆ ุฃู ุชุนุงุทู
   - ุงุนุทู ูุนูููุฉ ูููุฏุฉ ูุตูุฑุฉ
   - ุงุฎุชู ุจุชุดุฌูุน ุฃู ุฏุนูุฉ ููุญุฌุฒ

ูุซุงู ุนูู ุงูุฑุฏ ุงููุซุงูู:
"ูุง ุบุงูู ุญูุงู ุงููู! ๐ฟ
ูุฐุง ุงููู ุชุญูู ุนูู ุดููู ูู ุฃุนุฑุงุถ ุงูููููู ุงูุนุตุจู...
ุฌุฑุจ ุชุดุฑุจ ูุงุก ุฏุงูุฆ ูุน ููููู ุนูู ุงูุฑููุ ูุงูุดู 20 ุฏูููุฉ ููููุงู.
ุจุณ ูุงููู ูุง ุฃูุฏุฑ ุฃุฌุฒู ูู ูู ููุง - ุงูุฏูุชูุฑ ุนูุฑ ุงูุนูุงุฏ ูู ุงููู ุจูุดุฎุตู ูู ุงูุขุฎุฑ.
ุงูุฌูุณุฉ ุงูุชุดุฎูุตูุฉ ุนูุฏู ุจู25 ุฑ.ุณ ุจุณุ ูุจุชุฑูุญ ุจุงูู! ๐ช"
`;

const DISCLAIMER = "ูุฐุง ูุญุชูู ุชูุนูู/ุชุซููููุ ููุง ูุบูู ุนู ุงุณุชุดุงุฑุฉ ุงูุทุจูุจ ุฃู ุงููุฎุชุต.";

// Enhanced Fallback responses - more intelligent and contextual
const FALLBACK_SUGGESTIONS = [
    {
        focus_text: "ูููู ุนุงููุฉ ูุง ุจุทู! ๐ฟ ุฑูุฒ ุงูููู ุนูู ุฑุงุญุฉ ุจุงูู ูุชุบุฐูุชู.",
        suggestions: [
            "ุงุดุฑุจ ูุงุณุฉ ูุงุก ุฏุงูุฆ ูุน ููููู ุนูู ุงูุฑูู",
            "ุญุงูู ุชุชูุดู 20 ุฏูููุฉ ูู ุงูููุงุก ุงูุทูู",
            "ุชููุณ ุจุนูู ูููุง ุญุณูุช ุจุชูุชุฑ"
        ]
    },
    {
        focus_text: "ุตุจุงุญ ุงูุดูุงุก ูุง ุบุงูู! โ๏ธ ุงูููู ุฎูู ุฌุณูู ูุณุชุฑูุญ.",
        suggestions: [
            "ุงุจุฏุฃ ูููู ุจูุงุณุฉ ูุงุก ูุงุชุฑ ุนูู ุงูุฑูู",
            "ุชูุงูู ูุทูุฑ ุฎููู ุตุญู (ุจูุถ ูุณููู + ุฎุถุงุฑ)",
            "ุฎุฐ ูุณุท ูุงูู ูู ุงูููู ุงููููุฉ"
        ]
    },
    {
        focus_text: "ูุงููู ูุง ุดุงุก ุงููู ุนููู! ๐ช ูู ููู ุฌุฏูุฏ ูุฑุตุฉ ููุชุญุณู.",
        suggestions: [
            "ุงุดุฑุจ ุงูุญูุจุฉ - ุงููุนุฌุฒุฉ ุงูููููุฉ ูููุถู",
            "ููู ุงูุณูุฑ ูุงูุฎุจุฒ ุงูุฃุจูุถ ุงูููู",
            "ุฎุฐ 10 ุฏูุงุฆู ููุชุฃูู ุฃู ุงูุงุณุชุฑุฎุงุก"
        ]
    },
    {
        focus_text: "ุฃููุงู ูุณููุงู ูุง ุฎุจูุฑ! ๐ ุตุญุชู ุฃูุงูุฉุ ุงูุชู ุจูุง.",
        suggestions: [
            "ุงุดุฑุจ 8 ุฃููุงุจ ูุงุก ุนูู ุงูุฃูู ุงูููู",
            "ุชุฌูุจ ุงูุฃูู ุงูุซููู ูุจู ุงูููู",
            "ูุงุฑุณ ุชูุงุฑูู ุงูุชููุณ ุงูุนููู"
        ]
    }
];

// Enhanced chat responses based on keywords
const SMART_FALLBACK_RESPONSES: Record<string, string[]> = {
    'ุฃูู|ูุฌุน|ูุคูู': [
        "ูุง ุบุงููุ ุงูุฃูู ูุฐุง ูุฒุนุฌ ูุงููู! ๐ฟ ุฌุฑุจ ุงูุฑุงุญุฉ ูุงููุงุก ุงูุฏุงูุฆุ ูุฅุฐุง ุงุณุชูุฑ ุฃูุซุฑ ูู ูููููุ ุงูุฏูุชูุฑ ุนูุฑ ุงูุนูุงุฏ ููุฏุฑ ูุณุงุนุฏู - ุงูุฌูุณุฉ ุงูุชุดุฎูุตูุฉ ุจู25 ุฑ.ุณ ุจุณ!",
        "ุญูุงู ุงููู ูุง ุฎุจูุฑ! ๐ช ุงูุฃูู ุดูุก ูุง ูุงุฒู ุชุชุญููู ูุญุงูู. ุฌุฑุจ ููุงุฏุงุช ุฏุงูุฆุฉุ ูุฅุฐุง ูุง ุชุญุณูุ ุชูุงุตู ูุน ุงูุฏูุชูุฑ ุนูุฑ ุงูุนูุงุฏ - ูุชุฎุตุต ุจูุดุฎุต ุงูุณุจุจ ุงูุฌุฐุฑู."
    ],
    'ููู|ุฃุฑู|ุฃูุงู': [
        "ูุง ุบุงููุ ุงูููู ููู ุฌุฏุงู ููุดูุงุก! ๐ด ุฌุฑุจ ุชุดุฑุจ ุดุงู ุงูุจุงุจููุฌ ูุจู ุงููููุ ูุงุจุชุนุฏ ุนู ุงูุฌูุงู ุณุงุนุฉ ูุจู ูุง ุชูุงู. ูุฅุฐุง ุงูุฃุฑู ูุณุชูุฑุ ุงูุฏูุชูุฑ ุนูุฑ ุนูุฏู ุญููู ุทุจูุนูุฉ ููุชุงุฒุฉ!",
        "ูุง ุนููู ูุง ุจุทู! ๐ ููููู ุงูุตุญู: ุบุฑูุฉ ูุธููุฉุ ุจุฏูู ุดุงุดุงุชุ ูููู ุจููุช ุซุงุจุช. ุฌุฑุจ ููุนูุฉ ุนุณู ูุน ูุงุก ุฏุงูุฆ ูุจู ุงูููู - ุณุฑ ูููู ูุฏูู!"
    ],
    'ูุถู|ูุนุฏุฉ|ุจุทู|ููููู': [
        "ูุง ุบุงููุ ูุดุงูู ุงููุถู ููุชุดุฑุฉ ูุซูุฑ! ๐ฟ ุฌุฑุจ ุงูุญูุจุฉ ุนูู ุงูุฑููุ ูุชุฌูุจ ุงูุฃูู ุงูุฏุณู. ุงูุฏูุชูุฑ ุนูุฑ ุงูุนูุงุฏ ูุชุฎุตุต ูู ุนูุงุฌ ุงูุณุจุจ ุงูุฌุฐุฑู ููุดุงูู ุงููุถู.",
        "ุฃุจุดุฑ ูุง ุฎุจูุฑ! ๐ช ุงูููููู ูุญุชุงุฌ ุตุจุฑ ูุชุบููุฑ ููุท ุงูุญูุงุฉ. ุงููุงุก ุงูุฏุงูุฆ ูุน ุงููููููุ ูุงูุงุจุชุนุงุฏ ุนู ุงูุชูุชุฑุ ูุงููุดู ุจุนุฏ ุงูุฃูู - ูููุง ุชุณุงุนุฏ!"
    ],
    'ุทุงูุฉ|ุชุนุจ|ุฅุฑูุงู': [
        "ูุง ุบุงููุ ุงูุชุนุจ ูู ุฃุณุจุงุจ ูุซูุฑุฉ! โ๏ธ ุชุฃูุฏ ุฅูู ุชุดุฑุจ ูุงุก ูุงููุ ูุชูุงู 7-8 ุณุงุนุงุชุ ูุชุงูู ูุทูุฑ ุตุญู. ูุฅุฐุง ูุณุชูุฑุ ุงูุฏูุชูุฑ ุนูุฑ ููุฏุฑ ููุญุต ุงูุฃุณุจุงุจ.",
        "ูุง ุนููู ูุง ุจุทู! ๐ช ุงูุทุงูุฉ ุชูุฌู ูู ุงูููู ุงูุฌูุฏุ ุงูุฃูู ุงูุตุญูุ ูุงูุญุฑูุฉ. ุฌุฑุจ ุงููุดู 20 ุฏูููุฉ ููููุงู - ุจุชุญุณ ุจูุฑู ูุจูุฑ!"
    ],
    'default': [
        "ูุง ุบุงูู ุญูุงู ุงููู! ๐ฟ ุฃูุง ูุณุงุนุฏ ุทูุจุฑูุง ุงูุฐููุ ููุฌูุฏ ููุณุงุนุฏุชู ูู ุฃู ุณุคุงู ุตุญู. ููู ุฃุฎุฏูู ุงููููุ",
        "ุฃููุงู ูุณููุงู ูุง ุฎุจูุฑ! ๐ ุณุนูุฏ ุฅูู ุชูุงุตูุช ูุนูุง. ุงุณุฃููู ุฃู ุดู ุนู ุตุญุชู ูุฃูุง ุญุงุถุฑ ุฃููุฏู.",
        "ูุฑุญุจุงู ูุง ุบุงูู! ๐ ุฃูุง ููุง ุนุดุงู ุฃุณุงุนุฏู. ูููู ุดู ุงููู ูุดุบู ุจุงูู ูุฃูุง ูุนุงู.",
        "ุญูุงู ุงููู ูุง ุจุทู! ๐ช ุฃูุง ูุณุงุนุฏู ุงูุตุญู. ุฅุฐุง ุนูุฏู ุฃู ุณุคุงู ุนู ุงูุตุญุฉ ุฃู ุงูุชุบุฐูุฉ ุฃู ููุท ุงูุญูุงุฉุ ุฃูุง ุฌุงูุฒ ุฃููุฏู."
    ]
};

// Get Gemini model
const getModel = () => {
    if (!genAI) return null;
    return genAI.getGenerativeModel({
        model: "gemini-1.5-flash",
        generationConfig: {
            temperature: 0.7,
            topK: 40,
            topP: 0.95,
            maxOutputTokens: 1024,
        }
    });
};

export const aiClient = {
    isEnabled: () => AI_ENABLED,

    async generateSuggestions(context: any) {
        if (!AI_ENABLED) {
            const randomIndex = Math.floor(Math.random() * FALLBACK_SUGGESTIONS.length);
            return FALLBACK_SUGGESTIONS[randomIndex];
        }

        try {
            const model = getModel();
            if (!model) throw new Error('Model not initialized');

            const prompt = `
${YEMENI_SYSTEM_PROMPT}

ุจูุงุกู ุนูู ุจูุงูุงุช ุงููุณุชุฎุฏู:
${JSON.stringify(context)}

ูู ุจุชูููุฏ:
1. ููุฑุฉ "ุชุฑููุฒ ุงูููู" (ููููุฉ ูุญุจุจุฉ ูุฏุงูุฆุฉุ ุฌููุฉ ุฃู ุงุซูุชูู)
2. 2-3 ุงูุชุฑุงุญุงุช ุตุญูุฉ ุจุณูุทุฉ ูุนูููุฉ

ุงูุฑุฏ JSON ููุท ุจุฏูู ุฃู ูุต ุฅุถุงูู:
{"focus_text": "string", "suggestions": ["string"]}
`;

            const result = await model.generateContent(prompt);
            const response = await result.response;
            const text = response.text();

            // Parse JSON from response
            const jsonMatch = text.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                return JSON.parse(jsonMatch[0]);
            }

            throw new Error('Invalid JSON response');
        } catch (error) {
            console.error("AI Suggestions Error:", error);
            const randomIndex = Math.floor(Math.random() * FALLBACK_SUGGESTIONS.length);
            return FALLBACK_SUGGESTIONS[randomIndex];
        }
    },

    async summarize(text: string, contextType: string = 'general') {
        if (!AI_ENABLED) {
            return "ูุง ุดุงุก ุงูููุ ุฑุญูุชู ุงูุนูุงุฌูุฉ ุชุณูุฑ ุจุฎุทู ุซุงุจุชุฉ! ๐ ุงุณุชูุฑุงุฑู ูู ุงููุชุงุจุนุฉ ูู ูุตู ุงูุนูุงุฌ.";
        }

        try {
            const model = getModel();
            if (!model) throw new Error('Model not initialized');

            const prompt = `
${YEMENI_SYSTEM_PROMPT}

ูู ุจุชูุฎูุต ุงููุต ุงูุชุงูู ูู ุณูุงู ${contextType}:
"${text}"

ุงูุชูุฎูุต ูุฌุจ ุฃู ูููู:
- ุจุงูููุฌุฉ ุงูููููุฉ ุงูุฏุงูุฆุฉ
- ูุดุฌุนุงู ูุฅูุฌุงุจูุงู
- ุฌููุชูู ุฃู ุซูุงุซ ููุท
`;

            const result = await model.generateContent(prompt);
            const response = await result.response;
            return response.text();
        } catch (error) {
            console.error("AI Summarize Error:", error);
            return "ูุง ุดุงุก ุงูููุ ุฑุญูุชู ุงูุนูุงุฌูุฉ ุชุณูุฑ ุจุฎุทู ุซุงุจุชุฉ! ๐ ุงุณุชูุฑุงุฑู ูู ุงููุชุงุจุนุฉ ูู ูุตู ุงูุนูุงุฌ.";
        }
    },

    async chat(messages: Array<{ role: string, content: string }>, contextData?: any, knowledgeBase?: any) {
        // Smart fallback - match message content to get relevant response
        const getSmartFallback = (userMessage: string): string => {
            for (const [pattern, responses] of Object.entries(SMART_FALLBACK_RESPONSES)) {
                if (pattern === 'default') continue;
                const regex = new RegExp(pattern, 'i');
                if (regex.test(userMessage)) {
                    return responses[Math.floor(Math.random() * responses.length)];
                }
            }
            const defaults = SMART_FALLBACK_RESPONSES['default'];
            return defaults[Math.floor(Math.random() * defaults.length)];
        };

        if (!AI_ENABLED) {
            console.warn('[AI Client] AI is disabled. Using smart fallback responses. Check NEXT_PUBLIC_GEMINI_API_KEY in .env.local');
            const lastMessage = messages[messages.length - 1]?.content || '';
            return getSmartFallback(lastMessage) + '\n\nโ๏ธ (ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุบูุฑ ูุชุตู ุญุงููุงู)';
        }

        try {
            const model = getModel();
            if (!model) throw new Error('Model not initialized');

            // Build chat history
            const recentMessages = Array.isArray(messages) ? messages.slice(-6) : [];
            const contextString = contextData ? JSON.stringify(contextData).slice(0, 1500) : "";
            const kbString = knowledgeBase ? JSON.stringify(knowledgeBase).slice(0, 2000) : "";

            const historyString = recentMessages
                .map(m => `${m.role === 'user' ? 'ุงููุณุชุฎุฏู' : 'ุงููุณุงุนุฏ'}: ${m.content}`)
                .join('\n');

            const prompt = `
${YEMENI_SYSTEM_PROMPT}

${kbString ? `๐ ูุนูููุงุช ูุฑุฌุนูุฉ ุนู ุฏ. ุนูุฑ ูุงูุฎุฏูุงุช:
${kbString}` : ''}

${contextString ? `๐ ุณูุงู ุงูุตูุญุฉ ุงูุญุงููุฉ:
${contextString}` : ''}

๐ฌ ุงููุญุงุฏุซุฉ:
${historyString}

โก ุชุนูููุงุช ุงูุฑุฏ:
- ุฃุฌุจ ุจุงูููุฌุฉ ุงูููููุฉ ุงูุฏุงูุฆุฉ
- ูู ูุฎุชุตุฑุงู ููููุฏุงู (3-5 ุฌูู ูุญุฏ ุฃูุตู)
- ุฅุฐุง ูุงู ุงูุณุคุงู ุตุญู: ุงุนุทู ูุตูุญุฉ ุนุงูุฉ + ุงูุชุฑุญ ุงูุฌูุณุฉ ุงูุชุดุฎูุตูุฉ
- ุงุณุชุฎุฏู ุงูุฅูููุฌู ุจุงุนุชุฏุงู

ุฃุฌุจ ุนูู ุขุฎุฑ ุฑุณุงูุฉ ูู ุงููุณุชุฎุฏู:
`;

            const result = await model.generateContent(prompt);
            const response = await result.response;
            return response.text();
        } catch (error) {
            console.error("AI Chat Error:", error);

            // Try with simpler prompt
            try {
                const model = getModel();
                if (!model) throw error;

                const lastMessage = messages[messages.length - 1]?.content || "";
                const simplePrompt = `ุฃูุช ูุณุงุนุฏ ุทูุจุฑูุง ุงูุตุญู ุจุงูููุฌุฉ ุงูููููุฉ. ุงููุณุชุฎุฏู ูููู: "${lastMessage}". ุฃุฌุจ ุจุงุฎุชุตุงุฑ ููุทู.`;

                const result = await model.generateContent(simplePrompt);
                const response = await result.response;
                return response.text();
            } catch (retryError) {
                console.error("AI Chat Retry Error:", retryError);
                const lastMessage = messages[messages.length - 1]?.content || '';
                return getSmartFallback(lastMessage);
            }
        }
    }
};

export const AI_DISCLAIMER = DISCLAIMER;
