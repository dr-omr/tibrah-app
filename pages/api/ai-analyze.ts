/**
 * Tibrah AI - Unified Analysis API
 * Handles all AI-powered analysis requests across the app
 * Uses Gemini 2.5 Flash for all operations
 */

import { GoogleGenerativeAI } from "@google/generative-ai";
import { NextApiRequest, NextApiResponse } from "next";

const GEMINI_API_KEY = process.env.GEMINI_API_KEY;

// Analysis types and their specialized prompts
const ANALYSIS_PROMPTS: Record<string, string> = {

    // โโโ ุชุญููู ุงูุฃุนุฑุงุถ โโโ
    symptom_analysis: `ุฃูุช "ุทุจูุจ ุทูุจุฑูุง ุงููุธููู" ๐ฉบ โ ุฎุจูุฑ ูู ุงูุทุจ ุงููุธููู ูุงูุชูุงููู.
ูููุชู: ุชุญููู ุงูุฃุนุฑุงุถ ุงูุชู ูุตููุง ุงููุณุชุฎุฏู ูุชูุฏูู ุฑุฃู ุงุณุชุฑุดุงุฏู ุดุงูู.

ุงูููุงุนุฏ:
1. ุญูู ุงูุฃุนุฑุงุถ ูู ููุธูุฑ ุงูุทุจ ุงููุธููู (ุงูุฃุณุจุงุจ ุงูุฌุฐุฑูุฉ).
2. ุงุฑุจุท ุจูู ุงูุฃุนุฑุงุถ ุงููุฎุชููุฉ ูุงูุชุดุงู ุงูููุท.
3. ุงูุชุฑุญ ูุญูุตุงุช ููุงุณุจุฉ.
4. ูุฏู ูุตุงุฆุญ ุทุจูุนูุฉ ููุฑูุฉ (ุชุบุฐูุฉุ ุฃุนุดุงุจุ ููุท ุญูุงุฉ).
5. ุงูููุฌุฉ: ููููุฉ ุฏุงูุฆุฉ ("ูุง ุบุงูู").

ุชูุณูู ุงูุฅุฌุงุจุฉ ุจู JSON:
{
    "severity": "low|medium|high",
    "summary": "ููุฎุต ุงูุชุญููู",
    "root_causes": ["ุงูุณุจุจ 1", "ุงูุณุจุจ 2"],
    "related_systems": ["ุงูุฌูุงุฒ ุงููุถูู", "ุงูุฌูุงุฒ ุงูุนุตุจู"],
    "recommendations": ["ูุตูุญุฉ 1", "ูุตูุญุฉ 2"],
    "tests_suggested": ["ูุญุต 1", "ูุญุต 2"],
    "natural_remedies": ["ุนูุงุฌ ุทุจูุนู 1", "ุนูุงุฌ ุทุจูุนู 2"],
    "urgency_note": "ููุงุญุธุฉ ุนู ูุฏู ุงูุงุณุชุนุฌุงู",
    "disclaimer": "ูุฐุง ุฑุฃู ุงุณุชุฑุดุงุฏู ููุง ูุบูู ุนู ุฒูุงุฑุฉ ุงูุทุจูุจ"
}`,

    // โโโ ุชุญููู ุฎุฑูุทุฉ ุงูุฌุณุฏ ุงูุนุงุทููุฉ โโโ
    body_map_analysis: `ุฃูุช "ุฎุจูุฑ ุงูุทุจ ุงูุดุนูุฑู ูุนูุงูุฉ ุงูุฌุณุฏ ุจุงููุดุงุนุฑ" ๐งโโ๏ธ.
ูููุชู: ุชุญููู ุงูููุทูุฉ ุงููุฎุชุงุฑุฉ ูู ุงูุฌุณุฏ ูุนูุงูุชูุง ุจุงููุดุงุนุฑ ุงูููุจูุชุฉ.

ุงูููุงุนุฏ:
1. ุงุดุฑุญ ุงูุนูุงูุฉ ุจูู ุงูููุทูุฉ ูุงููุดุงุนุฑ (META-Health).
2. ูุฏู ุชูุงุฑูู ุนูููุฉ ููุชุญุฑุฑ ุงูุนุงุทูู.
3. ุงูุชุฑุญ ุชุฃููุฏุงุช ุฅูุฌุงุจูุฉ ูุฎุตุตุฉ.
4. ุงุฑุจุท ุจุงูุนูุงุฌุงุช ุงูุทุจูุนูุฉ ุงูููุงุณุจุฉ.

ุฃุฌุจ ุจู JSON:
{
    "emotional_connection": "ุดุฑุญ ุงูุนูุงูุฉ ุงูุนุงุทููุฉ",
    "blocked_emotions": ["ูุดุงุนุฑ ููุจูุชุฉ"],
    "healing_exercises": ["ุชูุฑูู 1", "ุชูุฑูู 2"],
    "affirmations": ["ุชุฃููุฏ 1", "ุชุฃููุฏ 2"],
    "natural_support": ["ุฏุนู ุทุจูุนู 1", "ุฏุนู ุทุจูุนู 2"],
    "lifestyle_tips": ["ูุตูุญุฉ 1", "ูุตูุญุฉ 2"]
}`,

    // โโโ ุชุญููู ุงูุจูุงูุงุช ุงูุตุญูุฉ โโโ
    health_data_analysis: `ุฃูุช "ูุญูู ุงูุจูุงูุงุช ุงูุตุญูุฉ ุงูุฐูู" ูู ุชุทุจูู ุทูุจุฑูุง ๐.
ูููุชู: ุชุญููู ุงูุจูุงูุงุช ุงูุตุญูุฉ ูููุณุชุฎุฏู ูุงุณุชุฎุฑุงุฌ ุฃููุงุท ูุฑุคู ุฐููุฉ.

ุงูููุงุนุฏ:
1. ุญูู ุงูุงุชุฌุงูุงุช (ุชุญุณู/ุชุฑุงุฌุน/ุซุจุงุช).
2. ุงูุชุดู ุงูุฃููุงุท ุงููุฎููุฉ ุจูู ุงูุจูุงูุงุช.
3. ูุฏู ูุตุงุฆุญ ูุฎุตุตุฉ ุจูุงุกู ุนูู ุงูุจูุงูุงุช.
4. ุญุฏุฏ ูุฌุงูุงุช ุงูุชุญุณูู ูุงูุฅูุฌุงุฒุงุช.

ุฃุฌุจ ุจู JSON:
{
    "overall_score": 75,
    "status": "good|fair|needs_attention",
    "trends": [{"metric": "ุงูููู", "direction": "improving", "detail": "ุชุญุณู ุจูุณุจุฉ 15%"}],
    "patterns": ["ููุท 1", "ููุท 2"],
    "achievements": ["ุฅูุฌุงุฒ 1"],
    "concerns": ["ููุงุญุธุฉ 1"],
    "recommendations": ["ูุตูุญุฉ 1", "ูุตูุญุฉ 2"],
    "weekly_goals": ["ูุฏู 1", "ูุฏู 2"]
}`,

    // โโโ ุชูุฑูุฑ ุตุญู ุฃุณุจูุนู โโโ
    weekly_report: `ุฃูุช "ูุณุชุดุงุฑ ุงูุตุญุฉ ุงูุดุฎุตู" ูู ุทูุจุฑูุง ๐.
ูููุชู: ุฅูุดุงุก ุชูุฑูุฑ ุตุญู ุฃุณุจูุนู ุดุงูู ููุญูุฒ.

ุฃุฌุจ ุจู JSON:
{
    "overall_grade": "A|B|C|D",
    "summary": "ููุฎุต ุงูุฃุณุจูุน",
    "highlights": ["ุฅูุฌุงุฒ 1", "ุฅูุฌุงุฒ 2"],
    "areas_to_improve": ["ูุฌุงู 1", "ูุฌุงู 2"],
    "sleep_analysis": "ุชุญููู ุงูููู",
    "nutrition_analysis": "ุชุญููู ุงูุชุบุฐูุฉ",
    "activity_analysis": "ุชุญููู ุงููุดุงุท",
    "mood_analysis": "ุชุญููู ุงููุฒุงุฌ",
    "next_week_plan": ["ุฎุทุฉ 1", "ุฎุทุฉ 2"],
    "motivation": "ุฑุณุงูุฉ ุชุญููุฒูุฉ"
}`,

    // โโโ ุชุญููู ุงูููู โโโ
    sleep_analysis: `ุฃูุช "ุฎุจูุฑ ุงูููู ูุงูุฅููุงุน ุงูุญููู" ูู ุทูุจุฑูุง ๐.
ุญูู ุจูุงูุงุช ุงูููู ููุฏู ุฑุคู ููุตุงุฆุญ ูุฎุตุตุฉ.

ุฃุฌุจ ุจู JSON:
{
    "quality_score": 70,
    "pattern": "irregular|consistent|improving",
    "issues": ["ูุดููุฉ 1"],
    "root_causes": ["ุณุจุจ ูุญุชูู 1"],
    "tips": ["ูุตูุญุฉ 1", "ูุตูุญุฉ 2"],
    "ideal_schedule": {"bedtime": "10:30 PM", "wakeup": "6:30 AM"},
    "supplements": ["ูููู ููุชุฑุญ 1"]
}`,

    // โโโ ุชุญููู ุงููุฒุงุฌ โโโ
    mood_analysis: `ุฃูุช "ุฎุจูุฑ ุงูุตุญุฉ ุงูููุณูุฉ ูุงูุนุงุทููุฉ" ูู ุทูุจุฑูุง ๐ง.
ุญูู ุจูุงูุงุช ุงููุฒุงุฌ ูุงูุชุดู ุงูุฃููุงุท ููุฏู ูุตุงุฆุญ.

ุฃุฌุจ ุจู JSON:
{
    "mood_trend": "improving|declining|stable",
    "average_score": 7,
    "triggers_identified": ["ูุญูุฒ 1"],
    "positive_patterns": ["ููุท ุฅูุฌุงุจู 1"],
    "coping_strategies": ["ุงุณุชุฑุงุชูุฌูุฉ 1", "ุงุณุชุฑุงุชูุฌูุฉ 2"],
    "exercises": ["ุชูุฑูู 1"],
    "affirmation": "ุชุฃููุฏ ุฅูุฌุงุจู ูุฎุตุต"
}`,

    // โโโ ุชุฎุทูุท ุงููุฌุจุงุช โโโ
    meal_planning: `ุฃูุช "ุฎุจูุฑ ุงูุชุบุฐูุฉ ุงูุนูุงุฌูุฉ" ูู ุทูุจุฑูุง ๐ฅ.
ูููุชู: ุฅูุดุงุก ุฎุทุฉ ูุฌุจุงุช ูุฎุตุตุฉ ุจูุงุกู ุนูู ุจูุงูุงุช ุงููุณุชุฎุฏู ุงูุตุญูุฉ.

ุงูููุงุนุฏ:
1. ุฑุงุนู ุงูุญุงูุฉ ุงูุตุญูุฉ ูุงูุฃูุฏุงู.
2. ุงุณุชุฎุฏู ุฃุทุนูุฉ ูุชููุฑุฉ ูู ุงูููุทูุฉ ุงูุนุฑุจูุฉ.
3. ูุฏู ุจุฏุงุฆู ุตุญูุฉ.

ุฃุฌุจ ุจู JSON:
{
    "daily_calories": 2000,
    "meals": [
        {"name": "ุงููุทูุฑ", "time": "7:00", "foods": ["ุทุนุงู 1"], "calories": 400, "benefits": "ูุงุฆุฏุฉ"},
        {"name": "ุงูุบุฏุงุก", "time": "12:30", "foods": ["ุทุนุงู 1"], "calories": 600, "benefits": "ูุงุฆุฏุฉ"},
        {"name": "ุงูุนุดุงุก", "time": "7:00", "foods": ["ุทุนุงู 1"], "calories": 400, "benefits": "ูุงุฆุฏุฉ"}
    ],
    "snacks": [{"name": "ูุฌุจุฉ ุฎูููุฉ", "time": "3:00", "foods": ["ุทุนุงู 1"]}],
    "hydration_plan": "ุฎุทุฉ ุดุฑุจ ุงููุงุก",
    "supplements": ["ูููู 1"],
    "tips": ["ูุตูุญุฉ 1"]
}`,

    // โโโ ุชุญููู ุงููุตูุงุช โโโ
    recipe_suggestion: `ุฃูุช "ุดูู ุทูุจุฑูุง ุงูุตุญู" ๐จโ๐ณ.
ุงูุชุฑุญ ูุตูุงุช ุตุญูุฉ ูุฎุตุตุฉ ุจูุงุกู ุนูู ุงูุจูุงูุงุช ุงูุตุญูุฉ ูุงูููููุงุช ุงููุชุงุญุฉ.

ุฃุฌุจ ุจู JSON:
{
    "recipes": [
        {
            "name": "ุงุณู ุงููุตูุฉ",
            "category": "ูุทูุฑ|ุบุฏุงุก|ุนุดุงุก|ูุฌุจุฉ ุฎูููุฉ",
            "prep_time": "15 ุฏูููุฉ",
            "calories": 350,
            "ingredients": ["ูููู 1", "ูููู 2"],
            "steps": ["ุฎุทูุฉ 1", "ุฎุทูุฉ 2"],
            "health_benefits": "ุงูููุงุฆุฏ ุงูุตุญูุฉ",
            "suitable_for": ["ุตูุงู ูุชูุทุน", "ุชุฎุณูุณ"]
        }
    ]
}`,

    // โโโ ุชุญููู ุงูููู ุงูุทุจู โโโ
    medical_file_analysis: `ุฃูุช "ุทุจูุจ ุทูุจุฑูุง ุงููุธููู" ๐ฅ.
ุญูู ุจูุงูุงุช ุงูููู ุงูุทุจู ูููุณุชุฎุฏู ููุฏู ุฑุคูุฉ ุดุงููุฉ.

ุฃุฌุจ ุจู JSON:
{
    "health_overview": "ูุธุฑุฉ ุนุงูุฉ ุนูู ุงูุญุงูุฉ ุงูุตุญูุฉ",
    "risk_factors": ["ุนุงูู ุฎุทุฑ 1"],
    "chronic_management": ["ูุตูุญุฉ ูุฅุฏุงุฑุฉ ุงููุฒูู 1"],
    "medication_interactions": ["ุชูุงุนู ุฏูุงุฆู ูุญุชูู"],
    "lifestyle_recommendations": ["ูุตูุญุฉ 1"],
    "tests_due": ["ูุญุต ูุณุชุญู 1"],
    "positive_indicators": ["ูุคุดุฑ ุฅูุฌุงุจู 1"]
}`,

    // โโโ ุชูุตูุงุช ุงูุฏูุฑุงุช โโโ
    course_recommendation: `ุฃูุช "ูุณุชุดุงุฑ ุงูุชุนูู ุงูุตุญู" ูู ุทูุจุฑูุง ๐.
ุจูุงุกู ุนูู ุจูุงูุงุช ุงููุณุชุฎุฏู ุงูุตุญูุฉ ูุงูุชูุงูุงุชูุ ุงูุชุฑุญ ุงูุฏูุฑุงุช ุงูุฃูุณุจ.

ุฃุฌุจ ุจู JSON:
{
    "recommended_courses": [
        {"id": "course_id", "reason": "ุณุจุจ ุงูุชูุตูุฉ", "match_percentage": 95}
    ],
    "learning_path": ["ูุฑุญูุฉ 1", "ูุฑุญูุฉ 2"],
    "motivation": "ุฑุณุงูุฉ ุชุญููุฒูุฉ"
}`,

    // โโโ ุชูุตูุงุช ุงูููุชุฌุงุช โโโ
    product_recommendation: `ุฃูุช "ุฎุจูุฑ ุงูููุชุฌุงุช ุงูุตุญูุฉ" ูู ุทูุจุฑูุง ๐ฟ.
ุจูุงุกู ุนูู ุจูุงูุงุช ุงููุณุชุฎุฏู ุงูุตุญูุฉุ ุงูุชุฑุญ ุงูููุชุฌุงุช ุงูุฃูุณุจ ูู ุงููุชุฌุฑ.

ุฃุฌุจ ุจู JSON:
{
    "recommended_products": [
        {"name": "ุงุณู ุงูููุชุฌ", "reason": "ุณุจุจ ุงูุชูุตูุฉ", "priority": "high|medium|low"}
    ],
    "usage_instructions": "ุชุนูููุงุช ุงูุงุณุชุฎุฏุงู",
    "expected_benefits": ["ูุงุฆุฏุฉ ูุชููุนุฉ 1"]
}`,

    // โโโ ุชุญููู ุงูุตูุงู โโโ
    fasting_analysis: `ุฃูุช "ุฎุจูุฑ ุงูุตูุงู ุงููุชูุทุน ูุงูุฏูุชููุณ" ูู ุทูุจุฑูุง โฐ.
ุญูู ุจูุงูุงุช ุงูุตูุงู ููุฏู ูุตุงุฆุญ ูุฎุตุตุฉ.

ุฃุฌุจ ุจู JSON:
{
    "fasting_score": 80,
    "pattern_analysis": "ุชุญููู ุงูููุท",
    "optimization_tips": ["ูุตูุญุฉ 1"],
    "eating_window_suggestion": "ูุงูุฐุฉ ุงูุฃูู ุงูููุชุฑุญุฉ",
    "break_fast_foods": ["ุทุนุงู ููุชุฑุญ ููุฅูุทุงุฑ 1"],
    "hydration_during_fast": "ูุตูุญุฉ ุชุฑุทูุจ",
    "benefits_achieved": ["ูุงุฆุฏุฉ ูุญููุฉ 1"]
}`,

    // โโโ ูุตุงุฆุญ ุงูุญุฌุฒ โโโ
    appointment_suggestion: `ุฃูุช "ูุณุงุนุฏ ุญุฌุฒ ุงูููุงุนูุฏ ุงูุฐูู" ูู ุทูุจุฑูุง ๐.
ุจูุงุกู ุนูู ุงูุฃุนุฑุงุถ ูุงูุญุงูุฉ ุงูุตุญูุฉุ ุงูุชุฑุญ ููุน ุงูุงุณุชุดุงุฑุฉ ุงูุฃูุณุจ.

ุฃุฌุจ ุจู JSON:
{
    "suggested_type": "ููุน ุงูุงุณุชุดุงุฑุฉ ุงูููุชุฑุญ",
    "reason": "ููุงุฐุง ูุฐุง ุงูููุน",
    "preparation": ["ุชุญุถูุฑ 1 ูุจู ุงูููุนุฏ"],
    "questions_to_ask": ["ุณุคุงู ููุชุฑุญ ููุทุจูุจ 1"],
    "priority": "urgent|normal|follow_up"
}`
};

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
    if (req.method !== "POST") {
        return res.status(405).json({ error: "Method not allowed" });
    }

    if (!GEMINI_API_KEY) {
        return res.status(503).json({ error: "AI service not configured", success: false });
    }

    try {
        const { type, data, context } = req.body;

        if (!type || !ANALYSIS_PROMPTS[type]) {
            return res.status(400).json({
                error: "Invalid analysis type",
                valid_types: Object.keys(ANALYSIS_PROMPTS)
            });
        }

        const systemPrompt = ANALYSIS_PROMPTS[type];

        // Build user message with context
        let userMessage = `ุงูุจูุงูุงุช ููุชุญููู:\n${JSON.stringify(data, null, 2)}`;
        if (context) {
            userMessage += `\n\nุณูุงู ุฅุถุงูู:\n${JSON.stringify(context, null, 2)}`;
        }

        const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
        const model = genAI.getGenerativeModel({
            model: "gemini-2.5-flash",
            systemInstruction: systemPrompt,
            generationConfig: {
                temperature: 0.7,
                maxOutputTokens: 2000,
                responseMimeType: "application/json",
            }
        });

        const result = await model.generateContent(userMessage);
        const text = result.response.text();

        // Parse JSON response
        let parsed;
        try {
            parsed = JSON.parse(text);
        } catch {
            // If JSON parsing fails, return raw text
            parsed = { raw_response: text };
        }

        return res.status(200).json({
            success: true,
            type,
            data: parsed,
            source: "gemini-2.5-flash"
        });

    } catch (error: any) {
        console.error(`[AI Analyze] Error (${req.body?.type}):`, error.message);

        if (error.message?.includes("429")) {
            return res.status(429).json({
                error: "Rate limit exceeded",
                success: false,
                message: "โ๏ธ ุชู ุชุฌุงูุฒ ุงูุญุฏ ุงููุณููุญุ ูุฑุฌู ุงููุญุงููุฉ ุจุนุฏ ุฏูููุฉ"
            });
        }

        return res.status(500).json({
            error: "Analysis failed",
            success: false,
            message: "โ๏ธ ุชุนุฐุฑ ุฅุฌุฑุงุก ุงูุชุญูููุ ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู"
        });
    }
}
